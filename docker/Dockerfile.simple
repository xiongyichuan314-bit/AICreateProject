# ç®€å•çš„Dockerfileç”¨äºæµ‹è¯• - çº¯æœ¬åœ°ä¾èµ–æ–¹æ¡ˆ
# ä½¿ç”¨node:18-slimï¼ˆåŸºäºDebianï¼Œglibcï¼‰è§£å†³sqlite3äºŒè¿›åˆ¶å…¼å®¹æ€§é—®é¢˜
FROM node:18-slim

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# 1. å¤åˆ¶packageæ–‡ä»¶ï¼ˆç”¨äºç‰ˆæœ¬è®°å½•ï¼‰
COPY package*.json ./

# 2. å…³é”®ï¼šå¤åˆ¶æœ¬åœ°å·²å®‰è£…çš„ä¾èµ–ï¼ˆé›¶ä¸‹è½½ï¼‰
COPY node_modules ./node_modules

# 3. ç®€å•ä¾èµ–éªŒè¯
RUN echo "âœ… ä½¿ç”¨æœ¬åœ°ä¾èµ–ï¼Œæ— éœ€ç½‘ç»œä¸‹è½½" && \
    echo "ğŸ“¦ ä¾èµ–æ£€æŸ¥ï¼š" && \
    ls -la node_modules/express 2>/dev/null && echo "âœ… Expressä¾èµ–å­˜åœ¨" || echo "âš ï¸ Expressä¾èµ–ç¼ºå¤±" && \
    node -e "try { require('express'); console.log('âœ… Expresså¯ä»¥æ­£å¸¸åŠ è½½') } catch(e) { console.log('âŒ ExpressåŠ è½½å¤±è´¥:', e.message) }"

# 4. å¤åˆ¶åº”ç”¨ä»£ç 
COPY api/ ./api/
COPY config/ ./config/

# 5. åˆ›å»ºå¿…è¦çš„ç›®å½•
RUN mkdir -p logs data

# 6. å¤åˆ¶å¯åŠ¨è„šæœ¬
COPY scripts/ ./scripts/

# 7. æš´éœ²ç«¯å£
EXPOSE 8081

# 8. å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=30s --retries=3 \
  CMD curl -f http://localhost:8081/health || exit 1

# 9. å¯åŠ¨å‘½ä»¤
CMD ["node", "api/server.js"]
